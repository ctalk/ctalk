#!/bin/sh

# The -Wno-* warning options should work with most recent GCC
# versions.  If necessary, edit them for your compiler version and/or
# live with warning messages in the test output.  Refer to the README
# file in this directory.

INPUTNAME="!none"
BASENAME=
CTALKBIN=../../src/ctalk
GCCBIN=`which gcc`
GCCFLAGS="-Wno-nonnull -Wno-pointer-to-int-cast -Wno-format-overflow -Wno-address-of-packed-member"
CTALKFLAGS="-P "
EXTRALIBS="-lm @ac_ldflags@"
VERBOSE=n
KEEP=n
GCCMAJORVER=`../../build/gccmajorver.sh`
LD_LIBRARY_OPT="-L../../lib/.libs"

case $GCCMAJORVER in 
    4)
    GCCFLAGS="-g "$GCCFLAGS
    ;;
    *)
    GCCFLAGS=" "$GCCFLAGS
    ;;
esac

help () {
    echo "Usage: cttest [-v] [-k] input-file"
    exit 1;
}

if [ $# -eq 0 ] ; then help; fi

if [ $1 = '-v' ] ; then
    VERBOSE=y;
    shift 1;
    fi

if [ $1 = '-k' ] ; then
    KEEP=y;
    shift 1;
    fi

INPUTNAME=$1
BASENAME=`basename $1 .c`

if [ $VERBOSE = 'y' ] ; then
    echo "$CTALKBIN $CTALKFLAGS $INPUTNAME -o $BASENAME.i && $GCCBIN $GCCFLAGS $BASENAME.i -o $BASENAME $LD_LIBRARY_OPT -lctalk $EXTRALIBS";
    fi

$CTALKBIN $CTALKFLAGS $INPUTNAME -o $BASENAME.i && \
 $GCCBIN $GCCFLAGS $BASENAME.i -o $BASENAME $LD_LIBRARY_OPT -lctalk $EXTRALIBS
./$BASENAME

#if [ $KEEP = 'n' ]; then
##    rm -f $BASENAME.i $BASENAME
#fi



